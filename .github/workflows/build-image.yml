name: Build & Push via RunPod Kaniko

on:
    workflow_dispatch: 
  
jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Create build context tarball
        run: |
          tar -czf context.tar.gz .

      - name: Create GHCR config.json
        run: |
          echo "{\"auths\":{\"ghcr.io\":{\"auth\":\"$(echo -n '${{ secrets.GHCR_USERNAME }}:${{ secrets.GHCR_TOKEN }}' | base64)\"}}}" > config.json

      - name: Call RunPod serverless endpoint
        run: |
          curl -X POST https://api.runpod.ai/v2/6ryyh8usj7112j/run \
            -F context=@context.tar.gz \
            -F config=@config.json \
            -F DESTINATION_IMAGE=ghcr.io/${{ github.repository }}:latest

name: Build & Push via RunPod Kaniko

on:
    workflow_dispatch: 
  
jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Create build context tarball
        run: |
          mkdir context
          rsync -a --exclude=context . context/
          tar -czf context.tar.gz -C context .
            
      - name: Create GHCR config.json
        run: |
          echo "{\"auths\":{\"ghcr.io\":{\"auth\":\"$(echo -n '${{ secrets.GHCR_USERNAME }}:${{ secrets.GHCR_TOKEN }}' | base64)\"}}}" > config.json

      - name: Call RunPod serverless endpoint
        run: |
            curl -i -v -X POST https://api.runpod.ai/v2/<your-endpoint-id>/run \
                -F context=@context.tar.gz \
                -F config=@config.json \
                -F DESTINATION_IMAGE=ghcr.io/${{ github.repository }}:latest
        
      - name: Cleanup build context
        run: rm -f context.tar.gz
          
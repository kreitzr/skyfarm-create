name: Build & Push via RunPod Kaniko

on:
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Create build context tarball
        run: |
          mkdir context
          rsync -a --exclude=context . context/
          tar -czf context.tar.gz -C context .

      - name: Create GHCR config.json
        run: |
            AUTH=$(echo -n "${{ secrets.GHCR_USERNAME }}:${{ secrets.GHCR_TOKEN }}" | base64)
            echo "{\"auths\":{\"ghcr.io\":{\"auth\":\"$AUTH\"}}}" > config.json
            cat config.json
                                
      - name: Call RunPod serverless endpoint
        run: |
              RESPONSE=$(bash <<'EOF'
              curl -s -w "\n%{http_code}" -o response.json \
                -X POST https://api.runpod.ai/v2/${{ secrets.RUNPOD_ENDPOINT_ID }}/run \
                -H "Authorization: Bearer ${{ secrets.RUNPOD_API_KEY }}" \
                -F context=@context.tar.gz \
                -F config=@config.json\\;type=application/json \
                -F DESTINATION_IMAGE=ghcr.io/${{ github.repository }}:latest
              EOF
              )
          
              CODE=$(echo "$RESPONSE" | tail -n1)
              echo "ðŸ“¦ RunPod responded with status: $CODE"
              echo "ðŸ“„ Response body:"
              cat response.json || echo "âš ï¸ No response body received"
          
              if [ "$CODE" -ne 200 ]; then
                echo "âŒ RunPod request failed with status $CODE"
                echo "ðŸ’¥ Error details from RunPod:"
                cat response.json
                exit 1
              fi
                                                        
      - name: Cleanup
        run: rm -rf context context.tar.gz config.json response.json

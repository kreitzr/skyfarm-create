name: Build & Push via RunPod Kaniko

on:
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Create build context tarball
        run: |
          mkdir context
          rsync -a --exclude=context . context/
          tar -czf context.tar.gz -C context .

      - name: Create GHCR config.json
        run: |
          echo '{"auths":{"ghcr.io":{"auth":"'$(echo -n "${{ secrets.GHCR_USERNAME }}:${{ secrets.GHCR_TOKEN }}" | base64)'"}}}' > config.json
          cat config.json

      - name: Call RunPod serverless endpoint
        run: |
            RESPONSE=$(curl -s -w "%{http_code}" -o response.json \
              -X POST https://api.runpod.ai/v2/${{ secrets.RUNPOD_ENDPOINT_ID }}/run \
              -H "Authorization: Bearer ${{ secrets.RUNPOD_API_KEY }}" \
              -F context=@context.tar.gz \
              -F config=@config.json \
              -F DESTINATION_IMAGE=ghcr.io/${{ github.repository }}:latest)
        
            CODE=$(echo "$RESPONSE" | tail -c 4)
            echo "üì¶ RunPod responded with status: $CODE"
            echo "üìÑ Response body:"
            cat response.json || echo "‚ö†Ô∏è No response body received"
        
            if [ "$CODE" -ne 200 ]; then
              echo "‚ùå RunPod request failed with status $CODE"
              exit 1
            fi
                
      - name: Cleanup
        run: rm -rf context context.tar.gz config.json response.json
